const User = require('../models/users');

module.exports.profile = function(req, res){
    if (req.cookies.user_id){
        User.findById(req.cookies.user_id, function(err, user){
            if (user){
                return res.render('user_profile', {
                    title: "User Profile",
                    user: user
                })
            }else{
                //sigin req
                return res.redirect('/signin');

            }
        });
    }else{
        return res.redirect('/signin');

    }
}

// signup page
module.exports.signup=function(req,res){
   
   return res.render('signup',{
        title : 'Sign Up to codeial'
    })
}
// signin page
module.exports.signin=function(req,res){
    // res.end('<h1>Express up for codeial from controller ');

   return res.render('signin',{
        title : 'Login to codeial'
    })
}


// signup of user
module.exports.createAccount=function(req,res){
    //if password and conf-password dont match
      if(req.body.password != req.body.confirmPassword){
           return res.redirect('back');
        }
        // to find if password is already in use or not
        User.findOne({email: req.body.email}, function (err,user){
            if(err){ console.log('Error in finding email on signup page'); return}
            if(!user){

                User.create(
                    req.body
                    //old method used instead of directly using req.body
                    // {
                    // email: req.body.email,
                    // password: req.body.password,
                    // name: req.body.accountHolder
                    // }
                , function (err, newUser) {
                    if (err) {console.log('Error in creating User ', err); return;}
                     
                    return res.redirect('/signin');
                            })

            }else{
                console.log('Error email id is already in use');
                return res.redirect('back');
            }
        })
   
}

// signin Auth process creates session
module.exports.loginCreateSession=function(req,res){

    User.findOne({email: req.body.email}, function (err,user){
        if(err){ console.log('Error in finding email on signin page'); return}
        //handle user found
        if(user){
            // handle opassword wrong
            if(user.password !== req.body.password){
                return res.redirect('back');
            }
            // handle password correct
            else{
                
                res.cookie('user_id', user.id)
                return res.redirect('/users/profile');
            }
        }
        //handle user not found
        else{
            return res.redirect('back');
        }
    })
}


// signout process
module.exports.signout=function(req,res){
    res.clearCookie('user_id');
   
    return res.redirect('/signin');
 }
